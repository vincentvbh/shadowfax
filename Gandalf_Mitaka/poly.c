
#include "poly.h"
#include "fft.h"

#include <stdio.h>
#include <stddef.h>
#include <sys/types.h>
#include <assert.h>

// ========
// fpoly

void naive_mul(fpoly* c, const fpoly* a, const fpoly* b){

  int i, j;

  for(j=0; j < N; j++) {
    c->coeffs[j].v = a->coeffs[0].v*b->coeffs[j].v;
  }
  for(i=1; i < N; i++){
    for(j=0; j < N; j++){
      if (i + j < N) c->coeffs[i+j  ].v = c->coeffs[i+j  ].v + a->coeffs[i].v*b->coeffs[j].v;
      else           c->coeffs[i+j-N].v = c->coeffs[i+j-N].v - a->coeffs[i].v*b->coeffs[j].v;
    }
  }
}


void fpoly_FFT(fpoly* p){
  FFT(p->coeffs, LOG_N);
}

void fpoly_iFFT(fpoly* p){
  iFFT(p->coeffs, LOG_N);
}


void fpoly_pointwise_mul(fpoly* p1, const fpoly* p2){
  /* Multiplication in FFT form, result in p1*/
  fpr_poly_mul_fft(p1->coeffs, p2->coeffs, LOG_N);
}

void fpoly_add(fpoly* p1, const fpoly* p2){
  /* Addition result in p1*/
  fpr_poly_add(p1->coeffs, p2->coeffs, LOG_N);
}

void fpoly_sub(fpoly* p1, const fpoly* p2){
  /* Subtraction p1-p2 result in p1*/
  fpr_poly_sub(p1->coeffs, p2->coeffs, LOG_N);
}

void fpoly_div_FFT(fpoly* p1, const fpoly* p2){
  fpr_poly_div_fft(p1->coeffs, p2->coeffs, LOG_N);
}

void FFT_adj(fpoly* p){
  fpr_poly_adj_fft(p->coeffs, LOG_N);
}

void FFT_mul_adj(fpoly* p1, const fpoly* p2){
  fpr_poly_muladj_fft(p1->coeffs, p2->coeffs, LOG_N);
}

void FFT_mul_selfadj(fpoly *p1){
  fpr_poly_mulselfadj_fft(p1->coeffs, LOG_N);
}

void scalar_mul_FFT_form(double sigma2, fpoly* temp){
  for(size_t i = 0; i < N; i++){
    temp->coeffs[i].v = sigma2 * (temp->coeffs[i].v);
  }
}

void test_integral(const fpoly *p){

  int32_t t;

  for(size_t i = 0; i < N; i++){
    t = (int32_t)p->coeffs[i].v;
    assert(p->coeffs[i].v == (double)t);
  }

}

void ensure_integral(fpoly *des, const fpoly *src){

  int32_t t;

  for(size_t i = 0; i < N; i++){
    t = (int32_t)src->coeffs[i].v;
    des->coeffs[i].v = (double)t;
  }

}


// ========
// poly

int32_t CT_NTT_twiddle_table[NTT_N - 1] = {
-1479, -5146, 4043, -1305, 722, 5736, -4134, 3542, -3504, -2545, 3621, -1646, 1212, 3195, 5860, -4821, 2639, -2625, -949, -563, -2975, -3006, -2744, 5728, -4591, 5023, 5828, -3328, -5777, -4978, 1351, 2319, -1170, -955, -790, -3201, 3014, 5086, -1326, 4846, -2747, -3135, 3712, 4805, -3553, -1062, -2294, 3091, -81, -4320, -1000, -2963, -4896, -3051, 2366, -1177, -4255, -1635, -2768, -140, -1853, -4611, -726, 1260, 4388, 4632, -5755, 2426, 334, 1428, 1696, 2013, -3289, 729, 3241, 2881, 3284, -5092, -2089, -3694, -5179, -1759, -3707, 3382, -355, -2548, -4231, 3637, 3459, 145, -5542, -2731, -3932, -4890, -5911, -2842, 480, 1022, 9, -2468, 339, 5791, 544, -1673, 4278, -5331, -4989, -4177, -3584, 1381, -2525, -953, -3748, 827, 5767, 2476, 118, 2197, -5067, 3949, -3296, 4452, 2396, -4354, 130, 2837, -5374, 2401, 442, -5101, -1067, 390, 773, -3833, 3778, 354, 4861, -2912, 5698, 5012, -2481, 2859, -1045, 1017, -4885, 1632, -5084, 27, -3066, -3763, -1440, 1537, 242, 4714, -4143, -2678, 3704, 5019, -545, 1002, 5011, 5088, -4284, -4976, -1607, -3780, -875, -2437, 3646, 6022, 2987, -2566, -2187, -6039, -2422, -1065, 2143, -404, -4645, 1168, 5277, -1207, 3248, 493, -4096, -5444, 2381, -4337, -435, 1378, 1912, 2166, 3915, -113, -4919, -160, 3149, -3, 4437, 3636, 4938, 5291, 2704, -1426, -4654, 1663, -1777, 3364, 1689, 4057, -3271, -2847, -4414, 2174, 4372, -5042, -2305, 4053, 2645, 5195, -2780, -4895, 1484, -3247, -2686, -3978, -2969, -2370, 2865, 5332, 3510, 1630, -2126, 5407, 3186, -1153, -2884, -2249, -4048, -2399, -3400, -5191, -3136, -3000, 671, 3016, 243, -5559, 420, -2178, 1544, 3985, 4905, 3531, 476, 49, 1263, 5915, 1483, -2500, -1489, -1583, -5942, 1512, 350, -1815, 5383, 5369, -2057, -3202, 4493, -2738, -5868, -5735, 2655, -3009, 1693, 174, 723, -1975, -3757, 347, 2925, -3315, -426, 1858, 4754, 3030, 4115, 2361, -1843, 2908, 218, 3434, -3529, 3963, 576, 6142, -2447, 1954, -2051, -2882, -1805, 3991, -3969, -2767, 156, 2281, 5876, -2031, 5333, 3772, 418, 5908, -453, 5429, -4774, -4737, 1293, 295, 6099, 5766, 652, -4016, 4077, -3762, -2919, 325, -1404, -1146, -948, 5990, 1159, -3728, -4049, 3329, 4298, -168, 2692, 5961, -5106, -1962, 1594, -6122, -2555, -5184, -1200, 1360, 3956, -6119, 5297, -4079, -1058, 922, 441, 1958, 4322, 1112, 2078, 4046, 709, -3150, 1319, 4240, -3570, -6065, -835, 2459, 683, 3656, -64, -1566, 5782, -2948, -2503, -3123, -1747, -3054, -5486, -4433, -5919, 3834, -5257, -5241, -2920, -4169, -3127, -5468, 1010, -3482, 787, 5057, 4698, 4780, -3445, -192, 1321, 4912, -2049, 677, -5874, -6055, -3336, 1323, -2766, -52, 3174, 1579, -431, -2505, 5906, 3957, -2839, 151, -2127, -58, -241, 3532, -1003, 1956, -5009, -885, -6008, 3477, -5681, 142, -1105, -2844, 3438, -975, 4212, -3029, -5594, 4782, 5886, -4213, 504, 2302, -605, -421, -4080, 3602, 6068, -3600, 3263, 6077, -4624, -4467, -4789, -5537, 4749, 4449, -5456, -147, -3789, 6118, -3818, 1190, -2683, 3860, 5445, -4536, -1050, 5079, -3262, 2169, -522, -4324, 4916, -4075, 5315, -1278, -2344, 1973, -5574, -3514, -1041, 5925, -1018, 654, 3565, 1702, 1987, -5529, 5206, 3199, -56, 6136, -5862, -5415, -3643, 4948, -6137, 400, -1728, 5339, 5446, 3710, 6093, 468, -3988, 316, -382, -2033, -3998, 3879, 1922, -1359, -5435, 973, -1254
};

int32_t GS_iNTT_twiddle_table[NTT_N - 1] = {
1479, -4043, 5146, 4134, -5736, -722, 1305, -5860, -3195, -1212, 1646, -3621, 2545, 3504, -3542, -1351, 4978, 5777, 3328, -5828, -5023, 4591, -5728, 2744, 3006, 2975, 563, 949, 2625, -2639, 4821, 726, 4611, 1853, 140, 2768, 1635, 4255, 1177, -2366, 3051, 4896, 2963, 1000, 4320, 81, -3091, 2294, 1062, 3553, -4805, -3712, 3135, 2747, -4846, 1326, -5086, -3014, 3201, 790, 955, 1170, -2319, 5374, -2837, -130, 4354, -2396, -4452, 3296, -3949, 5067, -2197, -118, -2476, -5767, -827, 3748, 953, 2525, -1381, 3584, 4177, 4989, 5331, -4278, 1673, -544, -5791, -339, 2468, -9, -1022, -480, 2842, 5911, 4890, 3932, 2731, 5542, -145, -3459, -3637, 4231, 2548, 355, -3382, 3707, 1759, 5179, 3694, 2089, 5092, -3284, -2881, -3241, -729, 3289, -2013, -1696, -1428, -334, -2426, 5755, -4632, -4388, -1260, -476, -3531, -4905, -3985, -1544, 2178, -420, 5559, -243, -3016, -671, 3000, 3136, 5191, 3400, 2399, 4048, 2249, 2884, 1153, -3186, -5407, 2126, -1630, -3510, -5332, -2865, 2370, 2969, 3978, 2686, 3247, -1484, 4895, 2780, -5195, -2645, -4053, 2305, 5042, -4372, -2174, 4414, 2847, 3271, -4057, -1689, -3364, 1777, -1663, 4654, 1426, -2704, -5291, -4938, -3636, -4437, 3, -3149, 160, 4919, 113, -3915, -2166, -1912, -1378, 435, 4337, -2381, 5444, 4096, -493, -3248, 1207, -5277, -1168, 4645, 404, -2143, 1065, 2422, 6039, 2187, 2566, -2987, -6022, -3646, 2437, 875, 3780, 1607, 4976, 4284, -5088, -5011, -1002, 545, -5019, -3704, 2678, 4143, -4714, -242, -1537, 1440, 3763, 3066, -27, 5084, -1632, 4885, -1017, 1045, -2859, 2481, -5012, -5698, 2912, -4861, -354, -3778, 3833, -773, -390, 1067, 5101, -442, -2401, 1254, -973, 5435, 1359, -1922, -3879, 3998, 2033, 382, -316, 3988, -468, -6093, -3710, -5446, -5339, 1728, -400, 6137, -4948, 3643, 5415, 5862, -6136, 56, -3199, -5206, 5529, -1987, -1702, -3565, -654, 1018, -5925, 1041, 3514, 5574, -1973, 2344, 1278, -5315, 4075, -4916, 4324, 522, -2169, 3262, -5079, 1050, 4536, -5445, -3860, 2683, -1190, 3818, -6118, 3789, 147, 5456, -4449, -4749, 5537, 4789, 4467, 4624, -6077, -3263, 3600, -6068, -3602, 4080, 421, 605, -2302, -504, 4213, -5886, -4782, 5594, 3029, -4212, 975, -3438, 2844, 1105, -142, 5681, -3477, 6008, 885, 5009, -1956, 1003, -3532, 241, 58, 2127, -151, 2839, -3957, -5906, 2505, 431, -1579, -3174, 52, 2766, -1323, 3336, 6055, 5874, -677, 2049, -4912, -1321, 192, 3445, -4780, -4698, -5057, -787, 3482, -1010, 5468, 3127, 4169, 2920, 5241, 5257, -3834, 5919, 4433, 5486, 3054, 1747, 3123, 2503, 2948, -5782, 1566, 64, -3656, -683, -2459, 835, 6065, 3570, -4240, -1319, 3150, -709, -4046, -2078, -1112, -4322, -1958, -441, -922, 1058, 4079, -5297, 6119, -3956, -1360, 1200, 5184, 2555, 6122, -1594, 1962, 5106, -5961, -2692, 168, -4298, -3329, 4049, 3728, -1159, -5990, 948, 1146, 1404, -325, 2919, 3762, -4077, 4016, -652, -5766, -6099, -295, -1293, 4737, 4774, -5429, 453, -5908, -418, -3772, -5333, 2031, -5876, -2281, -156, 2767, 3969, -3991, 1805, 2882, 2051, -1954, 2447, -6142, -576, -3963, 3529, -3434, -218, -2908, 1843, -2361, -4115, -3030, -4754, -1858, 426, 3315, -2925, -347, 3757, 1975, -723, -174, -1693, 3009, -2655, 5735, 5868, 2738, -4493, 3202, 2057, -5369, -5383, 1815, -350, -1512, 5942, 1583, 1489, 2500, -1483, -5915, -1263, -49
};

int32_t CT_NTT_twiddle_Rmod_table[NTT_N - 1] = {
-1106, -1638, 1669, -253, 5517, -696, -2892, -4389, 2739, -1388, 589, 971, 1704, 4857, 5562, -6048, -1400, -5029, 3046, 3102, -4061, 519, -5683, -2289, 5956, -5957, -810, 918, -5932, -5052, 196, -3675, 3587, -1221, -624, 3165, 1074, -4165, 3246, -2799, -1672, 946, 1812, 2862, -5482, -5630, -5172, -3563, -2304, 10, -2501, 4473, -4085, -761, -5069, 657, -872, -1447, 1827, 2845, -4917, -4171, -169, -1027, -4903, 672, 1521, 734, -4154, -4441, 5913, -90, -2069, -3842, 4800, -5440, -3535, -102, 3390, -1300, 5616, 4584, 3792, 618, -4636, 2623, 3907, 3775, -4019, 2759, -613, 1514, -2608, 182, 1180, 2453, -2732, -2335, 256, -6025, 1450, -497, -2277, 203, -5301, -73, -2634, 5443, -902, -3047, -3550, -3895, -2836, 311, -5276, -4671, 1991, -318, 3340, 4457, -4999, -4448, 3977, -3688, -1764, 4232, -4027, -2708, -1082, -358, 1055, -5292, -1225, 208, -407, 5973, 1724, -2269, 954, -3539, -933, -604, -3781, 4350, 5786, 5458, 1491, 768, -5284, 4930, -4093, -2706, -4040, 1639, -3148, 4387, 219, -609, 3614, -173, -2202, 5450, 1034, 4563, -2016, 3081, 2420, 1684, 4031, -2119, 306, 2111, -763, 270, -6082, -1619, -1854, -568, 4420, -913, -1463, 3900, -4559, 4465, -4542, 3540, -546, -1839, 4012, 964, -232, 4262, 759, 3613, 2088, 5007, 4914, 4011, 3318, 5112, -2913, 4397, -2282, 1767, 4164, 878, 4072, 106, 2983, -4760, -1557, -3151, 2798, 5855, 4200, -5507, -2754, 588, 2867, -2430, 5582, -5422, -5579, 3222, 2794, -2551, 206, -1872, 3663, -1264, 1528, -4157, 3703, -3227, 4601, 5436, -2838, -3892, 5016, 34, -1130, -2918, 2283, 4786, -30, -1600, -5377, -2462, 3754, -507, 224, 5481, 4341, -1971, 2616, -4068, -5038, 5761, -4242, -108, -25, 2763, 5760, 6141, -968, 5722, 4283, -1577, -2527, 4502, 2180, -1416, 5134, -641, 1786, 4530, -2365, 853, 4180, -1560, -3092, 3043, -2823, -4174, 4268, -1768, -2685, 4260, 3717, 1616, -5998, -4672, 3470, 4828, -703, -1972, 4095, -2802, 2765, 5059, 1740, -5512, 4641, -2541, -2295, 490, 341, -2025, -3541, -422, -2601, -4674, -5861, 2831, 3500, 4226, 4847, 4534, 4008, -1167, 5533, -3939, 795, -901, 5367, 3593, -5199, -4410, -3069, -3923, 1709, 3798, -1169, -4998, -5936, -2255, 4826, 3414, 1473, 5704, -5962, 5637, -5181, 640, -307, 12, -5459, 452, -4902, -3371, -3625, -2693, 1311, -3814, 255, -289, -2684, 225, -972, -2342, -1680, -3577, 6113, -3651, 4958, -1835, -1904, 5769, -3785, 2950, -455, 4612, -753, -3293, 3903, -2809, 829, 3250, -1751, 3623, -413, -1545, -699, 2487, -3862, -5253, 2539, -1239, 1420, -2097, 4635, -2259, -1547, -580, -2410, -1365, 3439, -5018, -934, 4237, 867, -2916, -675, 765, -847, -4210, -3933, 2585, -1336, -5712, 5505, 6050, -1558, -5263, 5040, 3812, 2703, -3308, 1510, 2385, -472, 3501, -4310, -3507, 895, -5519, 2705, 5127, -520, 941, -3082, -5597, -4823, -3254, -4622, 4419, 2047, -5524, -2189, -2417, -1356, 1414, -2176, -4088, -36, -1920, 921, -75, 324, 4991, 4000, -437, -4994, -85, 2825, 4708, 4731, -5749, -1217, 560, -4877, -6134, 2904, 5194, -1301, 251, -2559, 5358, 1923, 4248, -3113, 515, 233, 4234, 5304, 3820, 3160, 4680, -3013, -1879, 1727, -2109, -2195, -5705, -4848, -491, 1138, 5220, -2888, 1634, 4247, -3994, -3883, 5916, 4, 1666, 6075, 4486, 1266, 1023, -1470, -4666, -5404, 2252, -389, -265, -1313, -1789, 3796, 1733, 5294
};

int32_t GS_iNTT_twiddle_Rmod_table[NTT_N - 1] = {
1106, -1669, 1638, 2892, 696, -5517, 253, -5562, -4857, -1704, -971, -589, 1388, -2739, 4389, -196, 5052, 5932, -918, 810, 5957, -5956, 2289, 5683, -519, 4061, -3102, -3046, 5029, 1400, 6048, 169, 4171, 4917, -2845, -1827, 1447, 872, -657, 5069, 761, 4085, -4473, 2501, -10, 2304, 3563, 5172, 5630, 5482, -2862, -1812, -946, 1672, 2799, -3246, 4165, -1074, -3165, 624, 1221, -3587, 3675, 4027, -4232, 1764, 3688, -3977, 4448, 4999, -4457, -3340, 318, -1991, 4671, 5276, -311, 2836, 3895, 3550, 3047, 902, -5443, 2634, 73, 5301, -203, 2277, 497, -1450, 6025, -256, 2335, 2732, -2453, -1180, -182, 2608, -1514, 613, -2759, 4019, -3775, -3907, -2623, 4636, -618, -3792, -4584, -5616, 1300, -3390, 102, 3535, 5440, -4800, 3842, 2069, 90, -5913, 4441, 4154, -734, -1521, -672, 4903, 1027, -2616, 1971, -4341, -5481, -224, 507, -3754, 2462, 5377, 1600, 30, -4786, -2283, 2918, 1130, -34, -5016, 3892, 2838, -5436, -4601, 3227, -3703, 4157, -1528, 1264, -3663, 1872, -206, 2551, -2794, -3222, 5579, 5422, -5582, 2430, -2867, -588, 2754, 5507, -4200, -5855, -2798, 3151, 1557, 4760, -2983, -106, -4072, -878, -4164, -1767, 2282, -4397, 2913, -5112, -3318, -4011, -4914, -5007, -2088, -3613, -759, -4262, 232, -964, -4012, 1839, 546, -3540, 4542, -4465, 4559, -3900, 1463, 913, -4420, 568, 1854, 1619, 6082, -270, 763, -2111, -306, 2119, -4031, -1684, -2420, -3081, 2016, -4563, -1034, -5450, 2202, 173, -3614, 609, -219, -4387, 3148, -1639, 4040, 2706, 4093, -4930, 5284, -768, -1491, -5458, -5786, -4350, 3781, 604, 933, 3539, -954, 2269, -1724, -5973, 407, -208, 1225, 5292, -1055, 358, 1082, 2708, -5294, -1733, -3796, 1789, 1313, 265, 389, -2252, 5404, 4666, 1470, -1023, -1266, -4486, -6075, -1666, -4, -5916, 3883, 3994, -4247, -1634, 2888, -5220, -1138, 491, 4848, 5705, 2195, 2109, -1727, 1879, 3013, -4680, -3160, -3820, -5304, -4234, -233, -515, 3113, -4248, -1923, -5358, 2559, -251, 1301, -5194, -2904, 6134, 4877, -560, 1217, 5749, -4731, -4708, -2825, 85, 4994, 437, -4000, -4991, -324, 75, -921, 1920, 36, 4088, 2176, -1414, 1356, 2417, 2189, 5524, -2047, -4419, 4622, 3254, 4823, 5597, 3082, -941, 520, -5127, -2705, 5519, -895, 3507, 4310, -3501, 472, -2385, -1510, 3308, -2703, -3812, -5040, 5263, 1558, -6050, -5505, 5712, 1336, -2585, 3933, 4210, 847, -765, 675, 2916, -867, -4237, 934, 5018, -3439, 1365, 2410, 580, 1547, 2259, -4635, 2097, -1420, 1239, -2539, 5253, 3862, -2487, 699, 1545, 413, -3623, 1751, -3250, -829, 2809, -3903, 3293, 753, -4612, 455, -2950, 3785, -5769, 1904, 1835, -4958, 3651, -6113, 3577, 1680, 2342, 972, -225, 2684, 289, -255, 3814, -1311, 2693, 3625, 3371, 4902, -452, 5459, -12, 307, -640, 5181, -5637, 5962, -5704, -1473, -3414, -4826, 2255, 5936, 4998, 1169, -3798, -1709, 3923, 3069, 4410, 5199, -3593, -5367, 901, -795, 3939, -5533, 1167, -4008, -4534, -4847, -4226, -3500, -2831, 5861, 4674, 2601, 422, 3541, 2025, -341, -490, 2295, 2541, -4641, 5512, -1740, -5059, -2765, 2802, -4095, 1972, 703, -4828, -3470, 4672, 5998, -1616, -3717, -4260, 2685, 1768, -4268, 4174, 2823, -3043, 3092, 1560, -4180, -853, 2365, -4530, -1786, 641, -5134, 1416, -2180, -4502, 2527, 1577, -4283, -5722, 968, -6141, -5760, -2763, 25, 108, 4242, -5761, 5038, 4068
};

int32_t CT_BIGNTT_twiddle_Rmod_table[NTT_N / 2 - 1] = {
23264183, 45430764, 44315772, 42854635, 4523048, -25628082, -9585167, 25443792, -9027558, -7814100, -7851700, -4484896, 22942175, 40421260, 4665431, -43508112, -3883520, 20486681, -3729924, -33886730, 3097638, 9890356, 18427544, -13162038, -28000025, -28366114, -1503319, 5694836, -33005208, 7748118, -9844889, -43745995, 3347525, 14427455, -38816780, -39127519, 21150241, 19574550, 37396874, 1212138, -46124702, 38213721, 21173186, 7487564, -6724387, -16211692, -35687246, -24177945, 7302528, -35041569, -43436443, -20622614, 33755084, 5432684, 17976995, 25179087, 14399543, 34093851, 41650667, 15935246, 43420712, -6536527, 24700266, -24054030, -28761259, 7537134, -32398252, -14787694, 44809926, -13482797, -38455969, -17085605, -39604611, 4699674, 25142983, 36249210, -19391724, 133188, -27375221, -37046034, 9966176, -45211158, -18325533, -22510401, -618000, 27890587, 9338738, 33103834, -44434571, -18079454, 40590311, 44817486, -6437159, 27705670, -6502331, -13102833, -34090299, 42344119, -3690719, 21565681, -21496069, 14330154, 37371031, 43716557, -12169902, 10346038, -39883421, 3797919, -20395104, 11609198, -3836791, -4527152, -7652205, -15543516, -22869739, -17029019, 46273525, 41364876, 35272820, -6229002, 31632558, 20910975, -14821561, 30632323, 43897042, -5399312, 252156, -24970118, -12596259, -27192639, 45299537, -44632048, -31661841, 37722444, 2433192, 6560355, 43697068, 28417649, -4403803, 2064045, 42273936, -30626650, -11616859, -19302797, -1502052, -23951467, 2312883, 15851282, 8112004, 38804999, 16825513, 41234611, 40844744, 3683862, -39651167, -42244981, -32593655, 33220870, 3203272, -9239771, -41962175, 18836054, 19736028, -21828062, 3788163, 1419669, 25565320, -26071676, -493990, -22850673, -13487743, 25472343, -21425234, -183747, 44925717, 37718554, 39199822, -6398307, 43428567, -44186237, -31132951, -33453976, -11518804, 20864955, -13722649, -15271155, -35428309, 45279853, -8789548, -34374615, 17086107, 24330757, -18753927, 46751256, 22333672, -40346641, -2115327, 16429825, 17605717, 29166339, -24127772, -21902538, -37481996, -7743034, 41868391, -15445434, -34614101, 36874726, -14908573, 23658745, -23948180, -29063312, -41391554, -39311477, -43792546, 22465976, -23549755, -467288, -30241110, 25370578, -21702644, -30832338, 5798297, 7209550, 11704058, -6137495, -15028679, -32023643, 23661783, 2254673, -7024958, 38430851, 6019971, -33114815, -31825804, 16221261, -13989269, 40038171, 33233070, 3256377, 29505482, 10377208, 44534111, -32921873, -46942925, -33484817, -25279555, 5368024, -45457965, 22494843, 38229355, 2700041, 26323971, -13772188, -39889490
};

int32_t GS_BIGiNTT_twiddle_Rmod_table[NTT_N / 2 - 1] = {
-23264183, -44315772, -45430764, 9585167, 25628082, -4523048, -42854635, -4665431, -40421260, -22942175, 4484896, 7851700, 7814100, 9027558, -25443792, 9844889, -7748118, 33005208, -5694836, 1503319, 28366114, 28000025, 13162038, -18427544, -9890356, -3097638, 33886730, 3729924, -20486681, 3883520, 43508112, -24700266, 6536527, -43420712, -15935246, -41650667, -34093851, -14399543, -25179087, -17976995, -5432684, -33755084, 20622614, 43436443, 35041569, -7302528, 24177945, 35687246, 16211692, 6724387, -7487564, -21173186, -38213721, 46124702, -1212138, -37396874, -19574550, -21150241, 39127519, 38816780, -14427455, -3347525, 43745995, -252156, 5399312, -43897042, -30632323, 14821561, -20910975, -31632558, 6229002, -35272820, -41364876, -46273525, 17029019, 22869739, 15543516, 7652205, 4527152, 3836791, -11609198, 20395104, -3797919, 39883421, -10346038, 12169902, -43716557, -37371031, -14330154, 21496069, -21565681, 3690719, -42344119, 34090299, 13102833, 6502331, -27705670, 6437159, -44817486, -40590311, 18079454, 44434571, -33103834, -9338738, -27890587, 618000, 22510401, 18325533, 45211158, -9966176, 37046034, 27375221, -133188, 19391724, -36249210, -25142983, -4699674, 39604611, 17085605, 38455969, 13482797, -44809926, 14787694, 32398252, -7537134, 28761259, 24054030, 39889490, 13772188, -26323971, -2700041, -38229355, -22494843, 45457965, -5368024, 25279555, 33484817, 46942925, 32921873, -44534111, -10377208, -29505482, -3256377, -33233070, -40038171, 13989269, -16221261, 31825804, 33114815, -6019971, -38430851, 7024958, -2254673, -23661783, 32023643, 15028679, 6137495, -11704058, -7209550, -5798297, 30832338, 21702644, -25370578, 30241110, 467288, 23549755, -22465976, 43792546, 39311477, 41391554, 29063312, 23948180, -23658745, 14908573, -36874726, 34614101, 15445434, -41868391, 7743034, 37481996, 21902538, 24127772, -29166339, -17605717, -16429825, 2115327, 40346641, -22333672, -46751256, 18753927, -24330757, -17086107, 34374615, 8789548, -45279853, 35428309, 15271155, 13722649, -20864955, 11518804, 33453976, 31132951, 44186237, -43428567, 6398307, -39199822, -37718554, -44925717, 183747, 21425234, -25472343, 13487743, 22850673, 493990, 26071676, -25565320, -1419669, -3788163, 21828062, -19736028, -18836054, 41962175, 9239771, -3203272, -33220870, 32593655, 42244981, 39651167, -3683862, -40844744, -41234611, -16825513, -38804999, -8112004, -15851282, -2312883, 23951467, 1502052, 19302797, 11616859, 30626650, -42273936, -2064045, 4403803, -28417649, -43697068, -6560355, -2433192, -37722444, 31661841, 44632048, -45299537, 27192639, 12596259, 24970118
};

int32_t BIGmul_Rmod_table[NTT_N / 2] = {
-24970118, 24970118, -12596259, 12596259, -27192639, 27192639, 45299537, -45299537, -44632048, 44632048, -31661841, 31661841, 37722444, -37722444, 2433192, -2433192, 6560355, -6560355, 43697068, -43697068, 28417649, -28417649, -4403803, 4403803, 2064045, -2064045, 42273936, -42273936, -30626650, 30626650, -11616859, 11616859, -19302797, 19302797, -1502052, 1502052, -23951467, 23951467, 2312883, -2312883, 15851282, -15851282, 8112004, -8112004, 38804999, -38804999, 16825513, -16825513, 41234611, -41234611, 40844744, -40844744, 3683862, -3683862, -39651167, 39651167, -42244981, 42244981, -32593655, 32593655, 33220870, -33220870, 3203272, -3203272, -9239771, 9239771, -41962175, 41962175, 18836054, -18836054, 19736028, -19736028, -21828062, 21828062, 3788163, -3788163, 1419669, -1419669, 25565320, -25565320, -26071676, 26071676, -493990, 493990, -22850673, 22850673, -13487743, 13487743, 25472343, -25472343, -21425234, 21425234, -183747, 183747, 44925717, -44925717, 37718554, -37718554, 39199822, -39199822, -6398307, 6398307, 43428567, -43428567, -44186237, 44186237, -31132951, 31132951, -33453976, 33453976, -11518804, 11518804, 20864955, -20864955, -13722649, 13722649, -15271155, 15271155, -35428309, 35428309, 45279853, -45279853, -8789548, 8789548, -34374615, 34374615, 17086107, -17086107, 24330757, -24330757, -18753927, 18753927, 46751256, -46751256, 22333672, -22333672, -40346641, 40346641, -2115327, 2115327, 16429825, -16429825, 17605717, -17605717, 29166339, -29166339, -24127772, 24127772, -21902538, 21902538, -37481996, 37481996, -7743034, 7743034, 41868391, -41868391, -15445434, 15445434, -34614101, 34614101, 36874726, -36874726, -14908573, 14908573, 23658745, -23658745, -23948180, 23948180, -29063312, 29063312, -41391554, 41391554, -39311477, 39311477, -43792546, 43792546, 22465976, -22465976, -23549755, 23549755, -467288, 467288, -30241110, 30241110, 25370578, -25370578, -21702644, 21702644, -30832338, 30832338, 5798297, -5798297, 7209550, -7209550, 11704058, -11704058, -6137495, 6137495, -15028679, 15028679, -32023643, 32023643, 23661783, -23661783, 2254673, -2254673, -7024958, 7024958, 38430851, -38430851, 6019971, -6019971, -33114815, 33114815, -31825804, 31825804, 16221261, -16221261, -13989269, 13989269, 40038171, -40038171, 33233070, -33233070, 3256377, -3256377, 29505482, -29505482, 10377208, -10377208, 44534111, -44534111, -32921873, 32921873, -46942925, 46942925, -33484817, 33484817, -25279555, 25279555, 5368024, -5368024, -45457965, 45457965, 22494843, -22494843, 38229355, -38229355, 2700041, -2700041, 26323971, -26323971, -13772188, 13772188, -39889490, 39889490
};

void print_poly(poly *src){
    for(size_t i = 0; i < N; i++){
        printf("%4zu: %12d\n", i, src->coeffs[i]);
    }
}

void poly_add(poly *des, const poly *src1, const poly *src2){
    for(size_t i = 0; i < N; i++){
        des->coeffs[i] = src1->coeffs[i] + src2->coeffs[i];
    }
}

void poly_sub(poly *des, const poly *src1, const poly *src2){
    for(size_t i = 0; i < N; i++){
        des->coeffs[i] = src1->coeffs[i] - src2->coeffs[i];
    }
}

void poly_neg(poly *des, const poly *src){
    for(size_t i = 0; i < N; i++){
        des->coeffs[i] = -src->coeffs[i];
    }
}

int32_t montgomery_generic(int64_t a, ZArithData data){

    int32_t lo;
    int64_t hi;

    lo = (int32_t)a * data.modMontgomeryFactor;
    hi = (int64_t)lo * data.mod;
    return (int32_t)((a - hi) >> 32);

}

int32_t barrett_generic(int64_t a, ZArithData data){

    int64_t hi;

    hi = a * (int64_t)data.modBarrettFactor;
    hi += 1LL << 31;
    a -= (hi >> 32) * data.mod;

    return (int32_t)a;

}

int32_t freeze_generic(int32_t a, ZArithData data){
    return barrett_generic(barrett_generic(a, data), data);
}

void poly_freeze_generic(poly *des, const poly *src, ZArithData data){
    for(size_t i = 0; i < N; i++){
        des->coeffs[i] = freeze_generic(src->coeffs[i], data);
    }
}

void poly_freeze(poly *des, const poly *src){
    const ZArithData data = {Q, BarrettFactor, NTTFinalFactor, RmodQ, R2modQ, MontgomeryFactor, MontgomeryNTTFinalFactor};
    poly_freeze_generic(des, src, data);
}

void poly_ufreeze(poly *des, const poly *src){
    const ZArithData data = {Q, BarrettFactor, NTTFinalFactor, RmodQ, R2modQ, MontgomeryFactor, MontgomeryNTTFinalFactor};
    poly_freeze_generic(des, src, data);
    for(size_t i = 0; i < N; i++){
        if(des->coeffs[i] < 0){
            des->coeffs[i] += data.mod;
        }
    }
}

int32_t mq_div(int32_t x, int32_t y) {

    const ZArithData data = {Q, BarrettFactor, NTTFinalFactor, RmodQ, R2modQ, MontgomeryFactor, MontgomeryNTTFinalFactor};

    /*
     * We invert y by computing y^(q-2) mod q.
     *
     * We use the following addition chain for exponent e = 12287:
     *
     *   e0 = 1
     *   e1 = 2 * e0 = 2
     *   e2 = e1 + e0 = 3
     *   e3 = e2 + e1 = 5
     *   e4 = 2 * e3 = 10
     *   e5 = 2 * e4 = 20
     *   e6 = 2 * e5 = 40
     *   e7 = 2 * e6 = 80
     *   e8 = 2 * e7 = 160
     *   e9 = e8 + e2 = 163
     *   e10 = e9 + e8 = 323
     *   e11 = 2 * e10 = 646
     *   e12 = 2 * e11 = 1292
     *   e13 = e12 + e9 = 1455
     *   e14 = 2 * e13 = 2910
     *   e15 = 2 * e14 = 5820
     *   e16 = e15 + e10 = 6143
     *   e17 = 2 * e16 = 12286
     *   e18 = e17 + e0 = 12287
     *
     * Additions on exponents are converted to Montgomery
     * multiplications. We define all intermediate results as so
     * many local variables, and let the C compiler work out which
     * must be kept around.
     */
    int32_t y0, y1, y2, y3, y4, y5, y6, y7, y8, y9;
    int32_t y10, y11, y12, y13, y14, y15, y16, y17, y18;

    y0 = y;
    y1 = montgomery_generic(y0 * y0, data);
    y2 = montgomery_generic(y1 * y0, data);
    y3 = montgomery_generic(y2 * y1, data);
    y4 = montgomery_generic(y3 * y3, data);
    y5 = montgomery_generic(y4 * y4, data);
    y6 = montgomery_generic(y5 * y5, data);
    y7 = montgomery_generic(y6 * y6, data);
    y8 = montgomery_generic(y7 * y7, data);
    y9 = montgomery_generic(y8 * y2, data);
    y10 = montgomery_generic(y9 * y8, data);
    y11 = montgomery_generic(y10 * y10, data);
    y12 = montgomery_generic(y11 * y11, data);
    y13 = montgomery_generic(y12 * y9, data);
    y14 = montgomery_generic(y13 * y13, data);
    y15 = montgomery_generic(y14 * y14, data);
    y16 = montgomery_generic(y15 * y10, data);
    y17 = montgomery_generic(y16 * y16, data);
    y18 = montgomery_generic(y17 * y0, data);
    y18 = montgomery_generic(x * y18, data);

    return montgomery_generic(y18, data);

}

int32_t mq_div_montgomery(int32_t x, int32_t y) {

    const ZArithData data = {Q, BarrettFactor, NTTFinalFactor, RmodQ, R2modQ, MontgomeryFactor, MontgomeryNTTFinalFactor};

    /*
     * We invert y by computing y^(q-2) mod q.
     *
     * We use the following addition chain for exponent e = 12287:
     *
     *   e0 = 1
     *   e1 = 2 * e0 = 2
     *   e2 = e1 + e0 = 3
     *   e3 = e2 + e1 = 5
     *   e4 = 2 * e3 = 10
     *   e5 = 2 * e4 = 20
     *   e6 = 2 * e5 = 40
     *   e7 = 2 * e6 = 80
     *   e8 = 2 * e7 = 160
     *   e9 = e8 + e2 = 163
     *   e10 = e9 + e8 = 323
     *   e11 = 2 * e10 = 646
     *   e12 = 2 * e11 = 1292
     *   e13 = e12 + e9 = 1455
     *   e14 = 2 * e13 = 2910
     *   e15 = 2 * e14 = 5820
     *   e16 = e15 + e10 = 6143
     *   e17 = 2 * e16 = 12286
     *   e18 = e17 + e0 = 12287
     *
     * Additions on exponents are converted to Montgomery
     * multiplications. We define all intermediate results as so
     * many local variables, and let the C compiler work out which
     * must be kept around.
     */
    int32_t y0, y1, y2, y3, y4, y5, y6, y7, y8, y9;
    int32_t y10, y11, y12, y13, y14, y15, y16, y17, y18;

    y0 = y;
    y1 = montgomery_generic(y0 * y0, data);
    y2 = montgomery_generic(y1 * y0, data);
    y3 = montgomery_generic(y2 * y1, data);
    y4 = montgomery_generic(y3 * y3, data);
    y5 = montgomery_generic(y4 * y4, data);
    y6 = montgomery_generic(y5 * y5, data);
    y7 = montgomery_generic(y6 * y6, data);
    y8 = montgomery_generic(y7 * y7, data);
    y9 = montgomery_generic(y8 * y2, data);
    y10 = montgomery_generic(y9 * y8, data);
    y11 = montgomery_generic(y10 * y10, data);
    y12 = montgomery_generic(y11 * y11, data);
    y13 = montgomery_generic(y12 * y9, data);
    y14 = montgomery_generic(y13 * y13, data);
    y15 = montgomery_generic(y14 * y14, data);
    y16 = montgomery_generic(y15 * y10, data);
    y17 = montgomery_generic(y16 * y16, data);
    y18 = montgomery_generic(y17 * y0, data);
    y18 = montgomery_generic(x * y18, data);

    // 2^(-32) mod^+- Q = -432
    return montgomery_generic(y18 * (-432), data);

}

// ================
// NTT

static
void CT_butterfly_int32_generic(int32_t *a, int32_t *b, int32_t twiddle, ZArithData data){

    int32_t t;

    t = barrett_generic((int64_t)(*b) * twiddle, data);
    *b = *a - t;
    *a = *a + t;

}

static
void CT_butterfly_montgomery_int32_generic(int32_t *a, int32_t *b, int32_t twiddle, ZArithData data){

    int32_t t;

    t = montgomery_generic((int64_t)(*b) * twiddle, data);
    *b = *a - t;
    *a = *a + t;

}

static
void NTT_core_generic(poly *src, size_t level, int32_t *twiddle_table, ZArithData data){

    size_t step;
    int32_t *root_ptr;

    step = N >> (level + 1);
    root_ptr = twiddle_table + ((1u << level) - 1);

    for(size_t i = 0; i < N; i += 2 * step){
        for(size_t j =  0; j < step; j++){
            CT_butterfly_int32_generic(&src->coeffs[i + j], &src->coeffs[i + j + step], *root_ptr, data);
        }
        root_ptr += 1;
    }

}

static
void NTT_montgomery_core_generic(poly *src, size_t level, int32_t *twiddle_table, ZArithData data){

    size_t step;
    int32_t *root_ptr;

    step = N >> (level + 1);
    root_ptr = twiddle_table + ((1u << level) - 1);

    for(size_t i = 0; i < N; i += 2 * step){
        for(size_t j =  0; j < step; j++){
            CT_butterfly_montgomery_int32_generic(&src->coeffs[i + j], &src->coeffs[i + j + step], *root_ptr, data);
        }
        root_ptr += 1;
    }

}

void poly_NTT_montgomery_generic(poly *src, int32_t *twiddle_table, ZArithData data){
    for(size_t i = 0; i < 9; i++){
        NTT_montgomery_core_generic(src, i, twiddle_table, data);
    }
}

void poly_NTT_generic(poly *src, int32_t *twiddle_table, ZArithData data){
    for(size_t i = 0; i < 9; i++){
        NTT_core_generic(src, i, twiddle_table, data);
    }
}

void poly_BIGNTT_generic(poly *src, int32_t *twiddle_table, ZArithData data){
    for(size_t i = 0; i < 8; i++){
        NTT_montgomery_core_generic(src, i, twiddle_table, data);
    }
}

// ================
// iNTT

static
void GS_butterfly_int32_generic(int32_t *a, int32_t *b, int32_t twiddle, ZArithData data){

    int32_t t;

    t = (*a) - (*b);
    *a = (*a) + (*b);
    *b = barrett_generic((int64_t)t * twiddle, data);

}

static
void GS_butterfly_montgomery_int32_generic(int32_t *a, int32_t *b, int32_t twiddle, ZArithData data){

    int32_t t;

    t = (*a) - (*b);
    *a = (*a) + (*b);
    *b = montgomery_generic((int64_t)t * twiddle, data);

}

static
void iNTT_core_generic(poly *src, size_t level, int32_t *twiddle_table, ZArithData data){

    size_t step;
    int32_t *root_ptr;

    step = N >> (level + 1);
    root_ptr = twiddle_table + ((1u << level) - 1);

    for(size_t i = 0; i < N; i += 2 * step){
        for(size_t j = 0; j < step; j++){
            GS_butterfly_int32_generic(&src->coeffs[i + j], &src->coeffs[i + j + step], *root_ptr, data);
        }
        root_ptr += 1;
    }

}

static
void iNTT_montgomery_core_generic(poly *src, size_t level, int32_t *twiddle_table, ZArithData data){

    size_t step;
    int32_t *root_ptr;

    step = N >> (level + 1);
    root_ptr = twiddle_table + ((1u << level) - 1);

    for(size_t i = 0; i < N; i += 2 * step){
        for(size_t j = 0; j < step; j++){
            GS_butterfly_montgomery_int32_generic(&src->coeffs[i + j], &src->coeffs[i + j + step], *root_ptr, data);
        }
        root_ptr += 1;
    }

}

void poly_iNTT_generic(poly *src, int32_t *twiddle_table, ZArithData data){
    for(ssize_t i = 8; i >= 5; i--){
        iNTT_core_generic(src, i, twiddle_table, data);
    }
    for(size_t i = 0; i < N; i++){
        src->coeffs[i] = barrett_generic((int64_t)src->coeffs[i], data);
    }
    for(ssize_t i = 4; i >= 1; i--){
        iNTT_core_generic(src, i, twiddle_table, data);
    }
    for(size_t i = 0; i < N; i++){
        src->coeffs[i] = barrett_generic((int64_t)src->coeffs[i], data);
    }
    for(ssize_t i = 0; i >= 0; i--){
        iNTT_core_generic(src, i, twiddle_table, data);
    }
    for(size_t i = 0; i < N; i++){
        src->coeffs[i] = barrett_generic((int64_t)src->coeffs[i], data);
    }
    for(size_t i = 0; i < N; i++){
        src->coeffs[i] = freeze_generic(barrett_generic((int64_t)src->coeffs[i] * data.modNTTFinalFactor, data), data);
    }
}

void poly_iNTT_montgomery_generic(poly *src, int32_t *twiddle_table, ZArithData data){
    for(ssize_t i = 8; i >= 5; i--){
        iNTT_montgomery_core_generic(src, i, twiddle_table, data);
    }
    for(size_t i = 0; i < N; i++){
        src->coeffs[i] = montgomery_generic((int64_t)src->coeffs[i] * data.Rmod, data);
    }
    for(ssize_t i = 4; i >= 1; i--){
        iNTT_montgomery_core_generic(src, i, twiddle_table, data);
    }
    for(size_t i = 0; i < N; i++){
        src->coeffs[i] = montgomery_generic((int64_t)src->coeffs[i] * data.Rmod, data);
    }
    for(ssize_t i = 0; i >= 0; i--){
        iNTT_montgomery_core_generic(src, i, twiddle_table, data);
    }
    for(size_t i = 0; i < N; i++){
        src->coeffs[i] = freeze_generic(montgomery_generic((int64_t)src->coeffs[i] * data.modMontgomeryNTTFinalFactor, data), data);
    }
}

void poly_BIGiNTT_generic(poly *src, int32_t *twiddle_table, ZArithData data){
    for(ssize_t i = 7; i >= 4; i--){
        iNTT_montgomery_core_generic(src, i, twiddle_table, data);
    }
    for(size_t i = 0; i < N; i++){
        src->coeffs[i] = montgomery_generic((int64_t)src->coeffs[i] * data.Rmod, data);
    }
    for(ssize_t i = 3; i >= 0; i--){
        iNTT_montgomery_core_generic(src, i, twiddle_table, data);
    }
    for(size_t i = 0; i < N; i++){
        src->coeffs[i] = montgomery_generic((int64_t)src->coeffs[i] * data.modMontgomeryNTTFinalFactor, data);
    }
}

// ================
// point multiplication

void poly_point_mul_generic(poly *des, const poly *src1, const poly *src2, ZArithData data){
    for(size_t i = 0; i < N; i++){
        des->coeffs[i] = montgomery_generic((int64_t)src1->coeffs[i] * src2->coeffs[i], data);
    }
}

void poly_basemul2_generic(poly *des, const poly *src1, const poly *src2, ZArithData data){
    int32_t t, t0, t1;
    for(size_t i = 0; i < N; i += 2){
        t = montgomery_generic((int64_t)src2->coeffs[i + 1] * BIGmul_Rmod_table[i / 2], data);
        t0 = montgomery_generic((int64_t)src1->coeffs[i + 0] * src2->coeffs[i + 0] +
                             (int64_t)src1->coeffs[i + 1] * t,
                             data);
        t1 = montgomery_generic((int64_t)src1->coeffs[i + 0] * src2->coeffs[i + 1] +
                             (int64_t)src1->coeffs[i + 1] * src2->coeffs[i + 0],
                             data);
        des->coeffs[i + 0] = t0;
        des->coeffs[i + 1] = t1;
    }
}

// ================
// polynomial multiplication

void poly_mul(poly *des, const poly *src1, const poly *src2){

    poly NTT1, NTT2;

    const ZArithData data = {Q, BarrettFactor, NTTFinalFactor, RmodQ, R2modQ, MontgomeryFactor, MontgomeryNTTFinalFactor};

    NTT1 = *src1;
    NTT2 = *src2;

    poly_NTT_montgomery_generic(&NTT1, CT_NTT_twiddle_Rmod_table, data);
    poly_NTT_montgomery_generic(&NTT2, CT_NTT_twiddle_Rmod_table, data);

    poly_point_mul_generic(&NTT1, &NTT1, &NTT2, data);

    poly_iNTT_montgomery_generic(&NTT1, GS_iNTT_twiddle_Rmod_table, data);

    *des = NTT1;

}

// TODO: make this constant-time
bool poly_test_inv(const poly src){

    poly NTTsrc;
    const ZArithData data = {Q, BarrettFactor, NTTFinalFactor, RmodQ, R2modQ, MontgomeryFactor, MontgomeryNTTFinalFactor};

    NTTsrc = src;

    poly_NTT_montgomery_generic(&NTTsrc, CT_NTT_twiddle_Rmod_table, data);
    poly_freeze_generic(&NTTsrc, &NTTsrc, data);

    for(size_t i = 0; i < N; i++){
        if(NTTsrc.coeffs[i] == 0){
            return 0;
        }
    }

    return 1;

}

// TODO: make this constant-time
bool poly_div(poly *des, const poly *src1, const poly *src2){

    poly NTTsrc1, NTTsrc2;
    const ZArithData data = {Q, BarrettFactor, NTTFinalFactor, RmodQ, R2modQ, MontgomeryFactor, MontgomeryNTTFinalFactor};

    NTTsrc2 = *src2;
    poly_NTT_montgomery_generic(&NTTsrc2, CT_NTT_twiddle_Rmod_table, data);
    poly_freeze_generic(&NTTsrc2, &NTTsrc2, data);

    for(size_t i = 0; i < N; i++){
        if(NTTsrc2.coeffs[i] == 0){
            return 0;
        }
    }

    NTTsrc1 = *src1;
    poly_NTT_montgomery_generic(&NTTsrc1, CT_NTT_twiddle_Rmod_table, data);

    for(size_t i = 0; i < N; i++){
        des->coeffs[i] = mq_div_montgomery(NTTsrc1.coeffs[i], NTTsrc2.coeffs[i]);
    }

    poly_iNTT_montgomery_generic(des, GS_iNTT_twiddle_Rmod_table, data);

    return 1;

}

void poly_mul_big(poly *des, const poly *src1, const poly *src2){

    poly src1NTT, src2NTT;

    int32_t cmp_mask;

    // 7681 * 12289
    const int32_t auxQ = 94391809;
    // round(auxQ / 2^32)
    const int32_t auxBarrettFactor = 46;
    // 256^(-1) mod^+- auxQ
    const int32_t auxNTTFinalFactor = -368718;
    // 2^32 mod^+- auxQ
    const int32_t auxRmod = -47055918;
    // 2^64 mod^+- auxQ
    const int32_t auxR2mod = 33517767;
    // (NTT_N / 2)^(-1) mod^+- auxQ
    const int32_t auxMontgomeryFactor = -635194879;
    // 2^64 * (NTT_N / 2)^(-1) mod^+- auxQ
    const int32_t auxMontgomeryNTTFinalFactor = 21147855;

    const ZArithData data = {auxQ, auxBarrettFactor, auxNTTFinalFactor,
                             auxRmod, auxR2mod, auxMontgomeryFactor, auxMontgomeryNTTFinalFactor};

    src1NTT = *src1;
    src2NTT = *src2;

    poly_BIGNTT_generic(&src1NTT, CT_BIGNTT_twiddle_Rmod_table, data);
    poly_BIGNTT_generic(&src2NTT, CT_BIGNTT_twiddle_Rmod_table, data);

    poly_basemul2_generic(des, &src1NTT, &src2NTT, data);

    poly_BIGiNTT_generic(des, GS_BIGiNTT_twiddle_Rmod_table, data);

    for(size_t i = 0; i < N; i++){
        cmp_mask = des->coeffs[i] + (auxQ / 2);
        des->coeffs[i] += auxQ & (cmp_mask >> 31);
        cmp_mask = (auxQ / 2) - des->coeffs[i];
        des->coeffs[i] -= auxQ & (cmp_mask >> 31);
    }


}

// ========
// conversion

void fpoly_2_poly(poly *des, const fpoly *src){
    for(size_t i = 0; i < N; i++){
        des->coeffs[i] = src->coeffs[i].v;
    }
}

void poly_2_fpoly(fpoly *des, const poly *src){
    for(size_t i = 0; i < N; i++){
        des->coeffs[i].v = src->coeffs[i];
    }
}




